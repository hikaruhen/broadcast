
<!DOCTYPE html>

<html lang="zh-TW">
<head>
<link href="icon-192.png" rel="icon"/>
<link href="icon-192.png" rel="apple-touch-icon"/>
<meta charset="utf-8"/>
<title>班級無聲廣播系統</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
/* === 📐 CSS 排版說明 ===
 * body         ：整體畫面初始化樣式
 * .background  ：背景圖片容器（固定覆蓋全畫面）
 * .time        ：畫面頂部時間顯示
 * .content     ：中間公告輪播區
 * .page        ：公告每頁（輪播切換用）
 * .marquee     ：底部跑馬燈
 * #garbage-mode：播放垃圾車圖片與音樂的覆蓋區塊
 * #sound-indicator：音量圖示（右下角出現）
*/

    body {
      margin: 0;
      padding: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      overflow: hidden;
      color: #fff;
    }
    .background {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
    }
    .background img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 2s;
    }
    .background img.active {
      opacity: 1;
    }
    .time {
      font-size: 2em;
      text-align: center;
      padding: 10px;
    }
    .content {
      position: absolute;
      top: 60px;
      bottom: 80px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .page {
      display: none;
      font-size: 2em;
      text-align: center;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      word-break: break-word;
      white-space: normal;
    }
    .page.active {
      display: block;
    }
    .marquee {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: #ff0;
      font-size: 1.5em;
      white-space: nowrap;
      overflow: hidden;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 25s linear infinite;
    }
    @keyframes scroll-left {
      from { transform: translateX(0%); }
      to { transform: translateX(-100%); }
    }

    #garbage-mode {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #garbage-mode img {
      max-width: 80%;
      height: auto;
    }
  
#sound-indicator { position:fixed; bottom:10px; left:10px; z-index:5000; opacity:0.5; width:40px; height:40px; display:none; }
#sound-indicator {
  position: fixed;
  bottom: 10px;
  right: 10px;
  z-index: 9999;
  opacity: 0.6;
  width: 40px;
  height: 40px;
  display: none;
  pointer-events: none;
}
</style>
</head>
<body><img class="persistent-ui" id="sound-indicator" src="sound-icon.png"/>
<!-- 🔘 播放音效透明授權按鈕 -->
<button id="sound-auth-btn" style="position:fixed; top:0; left:0; width:100vw; height:100vh; opacity:0; z-index:10000;">點一下以啟用音效</button>
<div class="background">
<img class="active" src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be01.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be02.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be03.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be04.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be05.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be06.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be07.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be08.jpg"/>
<img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be09.jpg"/>
</div>
<div class="time" id="clock">載入中...</div>
<div class="content" id="announcement-area">
<div class="page active">📢 無聲廣播首頁</div>
</div>
<div class="marquee">
<div class="marquee-content" id="marquee-text">載入中...</div>
</div>
<div id="garbage-mode">
<img alt="垃圾車提醒" src="gomidashi_woman.png"/>
<audio id="garbage-music" loop="">
<source src="prayer.mp3" type="audio/mpeg"/>
</audio>
<script>
  // 提前播放授權（靜音預播）
  window.addEventListener("load", () => {
    const music = document.getElementById("garbage-music");
    if (music) {
      music.play().then(() => {
        music.pause();
        music.currentTime = 0;
        console.log("🔊 播放授權已獲得");
      }).catch(err => console.log("⚠️ 播放授權失敗，需使用者互動"));  
    }
  });
</script>
</div>
<script>// 🔧 廣播系統主控制腳本（含顯示時間、跑馬燈、播放時間排程等）

// 🎵 播放音樂授權：點擊畫面一次以啟用音訊播放（瀏覽器限制）
const music = document.getElementById("garbage-music");
const authBtn = document.getElementById("sound-auth-btn");
authBtn.addEventListener("click", () => {
  music.play().then(() => {
    music.pause();
    music.currentTime = 0;
    console.log("🔊 播放授權成功");
    document.getElementById('sound-indicator').style.display = 'block';
    authBtn.remove(); // 移除透明按鈕
  }).catch(err => {
    console.log("⚠️ 播放授權失敗", err);
  });
});

// 🕒 顯示時間（每秒更新一次）
function updateClock() {
  const now = new Date();
  const days = ['日', '一', '二', '三', '四', '五', '六'];
  const formatted = now.getFullYear() + '-' +
                    String(now.getMonth() + 1).padStart(2, '0') + '-' +
                    String(now.getDate()).padStart(2, '0') + '（' +
                    days[now.getDay()] + '） ' +
                    String(now.getHours()).padStart(2, '0') + ':' +
                    String(now.getMinutes()).padStart(2, '0') + ':' +
                    String(now.getSeconds()).padStart(2, '0');
  document.getElementById('clock').textContent = formatted;
}
setInterval(updateClock, 1000);
updateClock();

// 🔁 自動每 20 分鐘刷新頁面（使用 reload 保留 session）
setInterval(() => {
  location.reload();
}, 20 * 60 * 1000);

// 📄 從 Google Sheets 讀取公告與跑馬燈文字
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT4vzU7xZk5cwgUvNLxqjcDwn5ZnZ63o3XH8r5kK7oTvKQPSDjTezBWQbS-4wfyACro_-kCgJ1iNfFt/pub?output=csv')
  .then(response => response.text())
  .then(csvText => {
    const rows = csvText.trim().split('\n').map(row => row.replace(/^\ufeff/, ''));
    const lines = rows.map(row => {
      const commaIndex = row.indexOf(",");
      if (commaIndex === -1) return [row, ""];
      return [row.slice(0, commaIndex).trim(), row.slice(commaIndex + 1).trim()];
    });

    // 🧾 公告顯示區塊處理
    const container = document.getElementById('announcement-area');
    container.innerHTML = '';
    let marqueeParts = [];

    lines.forEach((columns, index) => {
      const page = document.createElement('div');
      page.className = 'page';
      if (index === 0) page.classList.add('active');
      page.textContent = columns[0];
      container.appendChild(page);
      if (columns[1]) {
        marqueeParts.push(columns[1]);
      }
    });

    // 🎞️ 跑馬燈文字
    const marquee = document.getElementById('marquee-text');
    if (marquee) {
      marquee.textContent = marqueeParts.join(' ✦ ') || '　';
    }

    // 📃 輪播公告頁面（3 秒切換）
    const pages = document.querySelectorAll('.page');
    let pageIndex = 0;
    setInterval(() => {
      pages[pageIndex].classList.remove('active');
      pageIndex = (pageIndex + 1) % pages.length;
      pages[pageIndex].classList.add('active');
    }, 3000);
  });

// 🖼️ 背景圖片輪播（每 5 秒切換一張）
const bgImgs = document.querySelectorAll('.background img');
let bgIndex = 0;
setInterval(() => {
  bgImgs[bgIndex].classList.remove('active');
  bgIndex = (bgIndex + 1) % bgImgs.length;
  bgImgs[bgIndex].classList.add('active');
}, 5000);

// 🕰️ 特定時間播放圖片與音樂（支援多段）
setInterval(() => {
  const now = new Date();
  const h = now.getHours();
  const m = now.getMinutes();

  // 🗓️ 播放時間表：可依需求新增更多段落
  const schedule = [
    {
      start: [12, 20], // 12:20 開始
      end: [12, 21],   // 12:21 結束
      image: "gomidashi_woman.png",
      audio: "prayer.mp3"
    },
    {
      start: [14, 51],
      end: [15, 5],
      image: "school_chiritori_houki.png",
      audio: "prayer.mp3"
    }
  ];

  const garbageDiv = document.getElementById("garbage-mode");
  const music = document.getElementById("garbage-music");
  const allContent = document.body.querySelectorAll("body > *:not(#garbage-mode):not(.persistent-ui)");

  let matched = null;
  for (const entry of schedule) {
    const [sh, sm] = entry.start;
    const [eh, em] = entry.end;
    const nowVal = h * 60 + m;
    const startVal = sh * 60 + sm;
    const endVal = eh * 60 + em;

    if (nowVal >= startVal && nowVal < endVal) {
      matched = entry;
      break;
    }
  }

  if (matched) {
    garbageDiv.style.display = "flex";
    allContent.forEach(el => el.style.display = "none");
    garbageDiv.querySelector("img").src = matched.image;
    if (music.src.indexOf(matched.audio) === -1) {
      music.src = matched.audio;
    }
    if (music.paused) {
      music.muted = false;
      music.play().catch(() => console.log("音樂播放被阻擋"));
    }
  } else {
    garbageDiv.style.display = "none";
    allContent.forEach(el => el.style.display = "");
    if (!music.paused) {
      music.pause();
      music.currentTime = 0;
    }
  }
}, 1000);


/* 🖱️ 使用者點一下畫面即提前退出播放狀態 */
document.addEventListener("click", () => {
  const garbageDiv = document.getElementById("garbage-mode");
  const music = document.getElementById("garbage-music");
  const allContent = document.body.querySelectorAll("body > *:not(#garbage-mode):not(.persistent-ui)");

  if (garbageDiv.style.display === "flex") {
    garbageDiv.style.display = "none";
    allContent.forEach(el => el.style.display = "");
    if (!music.paused) {
      music.pause();
      music.currentTime = 0;
    }
    console.log("🚪 使用者點擊，已退出播放模式");
  }
});
</script>
<div id="cleaning-mode" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:998; justify-content:center; align-items:center;">
<img alt="清掃提醒" src="cleaning_time.png" style="max-width:80%; height:auto;"/>
</div>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log("✅ Service worker registered"))
      .catch(err => console.log("❌ SW registration failed:", err));
  }
</script>
</body>
</html>
