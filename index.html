
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>班級無聲廣播系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="icon-192.png" rel="icon" />
  <link href="icon-192.png" rel="apple-touch-icon" />
  <style>
    body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; color: #fff; }
    .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .background img { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 2s; }
    .background img.active { opacity: 1; }
    .time { font-size: 2em; text-align: center; padding: 10px; }
    .content { position: absolute; top: 60px; bottom: 80px; width: 100%; display: flex; justify-content: center; align-items: center; }
    .page { display: none; font-size: 2em; text-align: center; padding: 20px; background-color: rgba(0, 0, 0, 0.5); border-radius: 20px; word-break: break-word; white-space: normal; }
    .page.active { display: block; }
    .marquee { position: fixed; bottom: 0; width: 100%; background: rgba(0, 0, 0, 0.7); color: #ff0; font-size: 1.5em; white-space: nowrap; overflow: hidden; }
    .marquee-content { display: inline-block; padding-left: 100%; animation: scroll-left 25s linear infinite; }
    @keyframes scroll-left { from { transform: translateX(0%); } to { transform: translateX(-100%); } }
    #garbage-mode, #cleaning-mode {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: black; z-index: 999; justify-content: center; align-items: center; flex-direction: column;
    }
    #garbage-mode img, #cleaning-mode img { max-width: 80%; height: auto; }
    #sound-indicator {
      position: fixed; bottom: 10px; right: 10px; z-index: 9999;
      opacity: 0.6; width: 40px; height: 40px; display: none; pointer-events: none;
    }
  </style>
</head>
<body>
<img class="persistent-ui" id="sound-indicator" src="sound-icon.png"/>
<button id="sound-auth-btn" style="position:fixed; top:0; left:0; width:100vw; height:100vh; opacity:0; z-index:10000;">點一下以啟用音效</button>
<div class="background"><img class="active" src="be01.jpg"/></div>
<div class="time" id="clock">載入中...</div>
<div class="content" id="announcement-area"><div class="page active">📢 無聲廣播首頁</div></div>
<div class="marquee"><div class="marquee-content" id="marquee-text">載入中...</div></div>
<div id="garbage-mode"><img src="gomidashi_woman.png"/><audio id="garbage-music" loop><source src="prayer.mp3" type="audio/mpeg"/></audio></div>
<div id="cleaning-mode"><img src="cleaning_time.png" /></div>

<script>
let userExitPlayback = false;
document.addEventListener("click", () => {
  const garbageDiv = document.getElementById("garbage-mode");
  const cleaningDiv = document.getElementById("cleaning-mode");
  const music = document.getElementById("garbage-music");
  const allContent = document.body.querySelectorAll("body > *:not(#garbage-mode):not(.persistent-ui):not(#cleaning-mode)");
  if (garbageDiv.style.display === "flex" || cleaningDiv.style.display === "flex") {
    userExitPlayback = true;
    garbageDiv.style.display = "none";
    cleaningDiv.style.display = "none";
    allContent.forEach(el => el.style.display = "");
    if (!music.paused) { music.pause(); music.currentTime = 0; }
    console.log("🖱️ 使用者點擊，中斷播放畫面");
  }
});
const music = document.getElementById("garbage-music");
const authBtn = document.getElementById("sound-auth-btn");
authBtn.addEventListener("click", () => {
  music.play().then(() => {
    music.pause(); music.currentTime = 0;
    console.log("🔊 播放授權成功");
    document.getElementById('sound-indicator').style.display = 'block'; authBtn.remove();
  }).catch(err => console.log("⚠️ 播放授權失敗", err));
});
function updateClock() {
  const now = new Date();
  const days = ['日','一','二','三','四','五','六'];
  const formatted = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + '（' + days[now.getDay()] + '） ' + String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0') + ':' + String(now.getSeconds()).padStart(2,'0');
  document.getElementById('clock').textContent = formatted;
}
setInterval(updateClock, 1000);
setInterval(() => { location.reload(); }, 20 * 60 * 1000);
updateClock();

// 撥放主邏輯
setInterval(() => {
  const now = new Date(); const h = now.getHours(); const m = now.getMinutes();
  const isCleaningTime = (h === 14 && m >= 51) || (h === 15 && m <= 5);
  const isGarbageTime = h === 12 && m === 20;
  const garbageDiv = document.getElementById("garbage-mode");
  const cleaningDiv = document.getElementById("cleaning-mode");
  const allContent = document.body.querySelectorAll("body > *:not(#garbage-mode):not(.persistent-ui):not(#cleaning-mode)");

  if (isGarbageTime && !userExitPlayback) {
    garbageDiv.style.display = "flex";
    allContent.forEach(el => el.style.display = "none");
    if (music && music.paused) { music.muted = false; music.play().catch(() => console.log("音樂播放被阻擋")); }
  } else {
    garbageDiv.style.display = "none";
    if (!isCleaningTime && !isGarbageTime) userExitPlayback = false;
    allContent.forEach(el => el.style.display = "");
    if (music && !music.paused) { music.pause(); music.currentTime = 0; }
  }

  if (isCleaningTime && !userExitPlayback) {
    console.log("🧹 清掃時間觸發", h + ":" + m);
    cleaningDiv.style.display = "flex";
    if (!garbageDiv || garbageDiv.style.display !== "flex") {
      allContent.forEach(el => el.style.display = "none");
    }
    if (music && music.paused) {
      music.muted = false;
      music.play().catch(() => console.log("音樂播放被阻擋（清掃）"));
    }
  } else {
    cleaningDiv.style.display = "none";
    if (!isCleaningTime && !isGarbageTime) userExitPlayback = false;
    if (!garbageDiv || garbageDiv.style.display !== "flex") {
      allContent.forEach(el => el.style.display = "");
    }
  }
}, 1000);

// fetch 試算表
fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT4vzU7xZk5cwgUvNLxqjcDwn5ZnZ63o3XH8r5kK7oTvKQPSDjTezBWQbS-4wfyACro_-kCgJ1iNfFt/pub?output=csv')
  .then(response => response.text())
  .then(csvText => {
    console.log("✅ 成功取得 CSV 資料：", csvText);
    const rows = csvText.trim().split('\n').map(row => row.replace(/^\ufeff/, ''));
    const lines = rows.map(row => {
      const commaIndex = row.indexOf(",");
      if (commaIndex === -1) return [row, ""];
      return [row.slice(0, commaIndex).trim(), row.slice(commaIndex + 1).trim()];
    });

    const container = document.getElementById('announcement-area');
    container.innerHTML = '';
    let marqueeParts = [];

    lines.forEach((columns, index) => {
      const page = document.createElement('div');
      page.className = 'page';
      if (index === 0) page.classList.add('active');
      page.textContent = columns[0];
      container.appendChild(page);
      if (columns[1]) {
        marqueeParts.push(columns[1]);
      }
    });

    const marquee = document.getElementById('marquee-text');
    if (marquee) {
      marquee.textContent = marqueeParts.join(' ✦ ') || '　';
    }

    const pages = document.querySelectorAll('.page');
    let pageIndex = 0;
    setInterval(() => {
      pages[pageIndex].classList.remove('active');
      pageIndex = (pageIndex + 1) % pages.length;
      pages[pageIndex].classList.add('active');
    }, 3000);
  })
  .catch(err => console.log("❌ 無法讀取試算表資料：", err));
</script>
</body>
</html>
