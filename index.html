
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <!-- head區塊：包含網頁的基本資訊與引入 manifest（PWA設定） -->
  <meta charset="UTF-8">
  <title>班級無聲廣播系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Microsoft JhengHei", sans-serif;
      overflow: hidden;
      color: #fff;
    }
    .background {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: -1;
    }
    .background img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 2s;
    }
    .background img.active {
      opacity: 1;
    }
    .time {
      font-size: 2em;
      text-align: center;
      padding: 10px;
    }
    .content {
      position: absolute;
      top: 60px;
      bottom: 80px;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .page {
      display: none;
      font-size: 2em;
      text-align: center;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      word-break: break-word;
      white-space: normal;
    }
    .page.active {
      display: block;
    }
    .marquee {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: #ff0;
      font-size: 1.5em;
      white-space: nowrap;
      overflow: hidden;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left {
      from { transform: translateX(0%); }
      to { transform: translateX(-100%); }
    }

    #garbage-mode {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: black;
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #garbage-mode img {
      max-width: 80%;
      height: auto;
    }
  </style>
</head>
<body>
  
  <!-- 背景圖片容器，會自動輪播，圖片放在 <img> 裡，並透過 JS 定時切換 .active -->
  <div class="background">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be01.jpg" class="active">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be02.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be03.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be04.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be05.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be06.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be07.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be08.jpg">
    <img src="https://raw.githubusercontent.com/hikaruhen/broadcast/main/be09.jpg">
  </div>

  
  <!-- 顯示當前時間的區塊，內容由 JS 每秒更新 -->
  <div class="time" id="clock">載入中...</div>

  
  <!-- 廣播主要內容顯示區塊，會由 Google Sheets 取得內容並輪播 -->
  <div class="content" id="announcement-area">
    <div class="page active">📢 無聲廣播首頁</div>
  </div>

  
  <!-- 跑馬燈區塊，會從 Google Sheets B 欄載入資料並橫向滾動 -->
  <div class="marquee">
    <div class="marquee-content" id="marquee-text">載入中...</div>
  </div>

  
  <!-- 垃圾車模式區塊：在特定時間（12:20）顯示圖片並播放音樂 -->
  <div id="garbage-mode">
    <img src="gomidashi_woman.png" alt="垃圾車提醒">
    <audio id="garbage-music" loop>
      <source src="prayer.mp3" type="audio/mpeg">
    </audio>
<script>
  // 提前播放授權（靜音預播）
  window.addEventListener("load", () => {
    const music = document.getElementById("garbage-music");
    if (music) {
      music.play().then(() => {
        music.pause();
        music.currentTime = 0;
        console.log("🔊 播放授權已獲得");
      }).catch(err => console.log("⚠️ 播放授權失敗，需使用者互動"));  
    }
  });
</script>
  </div>

  <script>
    function updateClock() {
      const now = new Date();
      const days = ['日', '一', '二', '三', '四', '五', '六'];
      const formatted = now.getFullYear() + '-' +
                        String(now.getMonth() + 1).padStart(2, '0') + '-' +
                        String(now.getDate()).padStart(2, '0') + '（' +
                        days[now.getDay()] + '） ' +
                        String(now.getHours()).padStart(2, '0') + ':' +
                        String(now.getMinutes()).padStart(2, '0') + ':' +
                        String(now.getSeconds()).padStart(2, '0');
      document.getElementById('clock').textContent = formatted;
    }
    setInterval(updateClock, 1000);
    // 自動每 5 分鐘刷新
    
    // 以下是主迴圈，每秒檢查時間是否進入垃圾車或清掃模式
    
    // 每 10 分鐘強制重新整理頁面，並加上 query string 避免快取
    setInterval(() => {
   location.href = location.pathname + '?t=' + new Date().getTime();
    }, 5 * 60 * 1000);
    updateClock();

    
    // 載入 Google Sheets 公開 csv 檔案，拆出每列的前後欄位
    fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vT4vzU7xZk5cwgUvNLxqjcDwn5ZnZ63o3XH8r5kK7oTvKQPSDjTezBWQbS-4wfyACro_-kCgJ1iNfFt/pub?output=csv')
      .then(response => response.text())
      .then(csvText => {
        const rows = csvText.trim().split('\n').map(row => row.replace(/^\ufeff/, ''));
        const lines = rows.map(row => {
          const commaIndex = row.indexOf(",");
          if (commaIndex === -1) return [row, ""];
          return [row.slice(0, commaIndex).trim(), row.slice(commaIndex + 1).trim()];
        });

        const container = document.getElementById('announcement-area');
        container.innerHTML = '';
        let marqueeParts = [];

        lines.forEach((columns, index) => {
          const page = document.createElement('div');
          page.className = 'page';
          if (index === 0) page.classList.add('active');
          page.textContent = columns[0];
          container.appendChild(page);
          if (columns[1]) {
            marqueeParts.push(columns[1]);
          }
        });

        const marquee = document.getElementById('marquee-text');
        if (marquee) {
          marquee.textContent = marqueeParts.join(' ✦ ') || '　';
        }

        const pages = document.querySelectorAll('.page');
        let pageIndex = 0;
        
    // 以下是主迴圈，每秒檢查時間是否進入垃圾車或清掃模式
    setInterval(() => {
          pages[pageIndex].classList.remove('active');
          pageIndex = (pageIndex + 1) % pages.length;
          pages[pageIndex].classList.add('active');
        }, 3000);
      });

    const bgImgs = document.querySelectorAll('.background img');
    let bgIndex = 0;
    
    // 以下是主迴圈，每秒檢查時間是否進入垃圾車或清掃模式
    setInterval(() => {
      bgImgs[bgIndex].classList.remove('active');
      bgIndex = (bgIndex + 1) % bgImgs.length;
      bgImgs[bgIndex].classList.add('active');
    }, 5000);

    
    // 以下是主迴圈，每秒檢查時間是否進入垃圾車或清掃模式
    setInterval(() => {
      const now = new Date();
      const h = now.getHours();
      const m = now.getMinutes();
      const isGarbageTime = h === 12 && m === 20;
      const garbageDiv = document.getElementById("garbage-mode");
      const music = document.getElementById("garbage-music");
      const allContent = document.body.querySelectorAll("body > *:not(#garbage-mode):not(#cleaning-mode)");

      if (isGarbageTime) {
        garbageDiv.style.display = "flex";
        allContent.forEach(el => el.style.display = "none");
        if (music && music.paused) {
            music.muted = false;
            music.play().catch(() => console.log("音樂播放被阻擋"));
            }

      } else {
        garbageDiv.style.display = "none";
        allContent.forEach(el => el.style.display = "");
        if (music && !music.paused) {
          music.pause();
          music.currentTime = 0;
        }
      }
    
      // 清掃圖片模式：14:51 ~ 15:05
      const isCleaningTime = (h === 14 && m >= 51) || (h === 15 && m <= 5);
      const cleaningDiv = document.getElementById("cleaning-mode");

      if (isCleaningTime) {
        cleaningDiv.style.display = "flex";
        if (!garbageDiv || garbageDiv.style.display !== "flex") {
          allContent.forEach(el => el.style.display = "none");
        }
      } else {
        cleaningDiv.style.display = "none";
        if (!garbageDiv || garbageDiv.style.display !== "flex") {
          allContent.forEach(el => el.style.display = "");
        }
      }

    }, 1000);
  </script>

  
  <!-- 清掃模式區塊：在 14:51~15:05 顯示清掃圖片，不播放音樂 -->
  <div id="cleaning-mode"  style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:998; justify-content:center; align-items:center;">
    <img src="cleaning_time.png" alt="清掃提醒" style="max-width:80%; height:auto;">
  </div>

</body>
</html>
